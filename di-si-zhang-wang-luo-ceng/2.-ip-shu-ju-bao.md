# 2. IP 数据报

## 1. IP 数据报格式

### 1.1 TCP/IP 协议栈

![](../.gitbook/assets/image%20%2896%29.png)

### 1.2 IP 数据报格式

![](../.gitbook/assets/image%20%28118%29.png)

#### 首部细节

![](../.gitbook/assets/image%20%28113%29.png)

**版本：**占 4 位，指 IP 协议的版本。（IPv4/IPv6）

**首部长度：**占 4 位，**单位是 4B**，最小为 5（因为首部固定部分 20B，5 \* 4B = 20B），最大为 15（15 \* 4B = 60B）

**区分服务：**占 8 位，用来获取更好的服务（如：优先级），但实际上一直没有用过

**总长度：**占 16 位，首部 + 数据部分的总长度，**单位是 1B**，因此数据报的总长度为 $$2^{16} - 1 = 65535 B$$ 

**生存时间（TTL）：**占 8 位，IP 分组的保质期，经过一个路由器就 -1，变为 0 则丢弃

**协议：**占 8 位，数据部分的协议，即传输层使用的是什么协议

| 协议名 | ICMP | IGMP | TCP | EGP | IGP | UDP | IPv6 | ESP | OSPF |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| 字段值 | 1 | 2 | **6** | 8 | 9 | **17** | 41 | 50 | 89 |

**首部检验和：**占 16 位，只检验数据报的首部，但不包含数据部分。每经过一个路由器，都会重新计算一下首部检验和。

**源地址：**占 32 位

**目的地址：**占 32 位

**可选字段：**占 0 ~ 40 位，用来支持排错、测量以及安全措施

**填充：**全 0，把首部长度补成 4B 的整数倍

### 1.3 IP 数据报分片

**最大传输单元MTU：**数据链路层帧可封装数据的上限，以太网的MTU是1500字节。

![](../.gitbook/assets/image%20%2894%29.png)

![](../.gitbook/assets/image%20%2892%29.png)

**标识：**占 16 位，同一数据报的分片使用同一标识

**标志：**占 3 位，只有两位有意义 x \_ \_

* 中间位 DF（Don't Fragment）
  * DF = 1，禁止分片
  * DF = 0，允许分片
* 最低位 MF（More Fragment）
  * MF = 1，后面还有分片
  * MF = 0，代表最后一片 / 没分片

**片偏移：**指出较长分组分片后，某片在原分组中的相对位置。**（以 8B 为单位）**

* 除了最后一片，每个分片长度一定是 **8B 的整数倍**

![](../.gitbook/assets/image%20%2868%29.png)

## 2. IPv4 地址

IP 地址是唯一标识一个计算机的地址

### 2.1 IP 编址的历史阶段

1. 分类的 IP 地址
2. 子网的划分
3. 构成超网（无分类编址方式）

### 2.2 分类的 IP 地址

IP 地址：全世界唯一的 **32 为 / 4 字节** 标识符，标识路由器主机的接口

IP 地址 ::= {&lt;网络号&gt;，&lt;主机号&gt;}

![](../.gitbook/assets/image%20%28147%29.png)

### 2.3 互联网中的 IP 地址

![](../.gitbook/assets/image%20%28151%29.png)

### 2.4 IP 地址的分类

![](../.gitbook/assets/image%20%28148%29.png)

### 2.5 特殊 IP 地址

![](../.gitbook/assets/image%20%28152%29.png)

### 2.6 私有 IP 地址

![](../.gitbook/assets/image%20%28150%29.png)

### 2.7 IP 地址的范围

![](../.gitbook/assets/image%20%28146%29.png)

对于 A 类地址，0.0.0.0 和 127.0.0.0 不能用作网络号

对于 B 类地址，128.0.0.0 不能作为网络号

对于 C 类地址，192.0.0.0 不能作为网络号

## 3. 网络地址转换（NAT）

对于私有IP地址是不能在网络上传输的，需要通过 NAT技术来实现私网IP和公网通信的功能。

网络地址转换 NAT（Network Address Translation）：在专用网连接到因特网的路由器上安装 NAT 软件，安装了 NAT 软件的路由器交**NAT路由器**，它至少有一个有效的**外部全球 IP地址**。

![](../.gitbook/assets/image%20%28149%29.png)

## 4. 子网划分 & 子网掩码

### 4.1 分类 IP 地址的弱点

1. IP 地址空间的利用率有时很低
2. 两级 IP 地址不够灵活

### 4.2 子网划分

**子网划分就是把一部分用来表示主机号的位数来表示网络号，用子网掩码区分。**

![](../.gitbook/assets/image%20%28156%29.png)

### 4.3 子网掩码

![](../.gitbook/assets/image%20%28159%29.png)

### 4.4 使用子网时分组的转发

![](../.gitbook/assets/image%20%28158%29.png)

**路由表中存储的信息：**

1. 目的网络地址
2. 目的网络子网掩码
3. 下一跳网址

**路由器转发分组的算法：**

1. 提取目的 IP地址
2. 是否直接交付
3. 特定主机交付
4. 检测路由表中有无路径
5. 默认路由 0.0.0.0
6. 丢弃，报告转发分组出错（TTL 为 0）

## 5. 无分类编址 CIDR

1. **消除了传统他的 A 类、B 类和 C 类地址以及划分子网的概念**

   ![](../.gitbook/assets/image%20%28157%29.png) 

   CIDR 记法：IP 地址后加上 /，然后写上网络前缀（可以是任意长度）的位数。e.g. 128.14.32.0**/20**

2.  **融合子网地址与子网掩码，方便子网划分**

   CIDR 把**网络前缀都相同**的连续的 IP 地址组成一个 CIDR地址块

### 5.1 构成超网

将多个子网聚合成一个较大的子网，叫做构成超网，或路由聚合

**方法：**将网络前缀缩短（所有网络地址取交集）

![](../.gitbook/assets/image%20%28155%29.png)

### 5.2 最长前缀匹配

使用 CIDR时，查找路由表可能得到几个匹配结果（**跟网络掩码按位相与**），应选择具有最长网络前缀的路由。前缀越长，地址块越小，路由越具体。

## 6. ARP 协议

对于数据链路层，通过 MAC 地址找到对应的主机。A 和 B 通信有两种情况：

* 情况一：A 和 B 在同一局域网内
* 情况二：A 和 B 不在同一局域网内

**对于情况一：主机 1 和主机 3 通信**

![](../.gitbook/assets/image%20%28160%29.png)

* 应用层：递交给传输层
* 传输层：分组，递交给网络层
* 网络层：对于第一个分组，加上源 IP 地址和目标 IP 地址，递交给数据链路层
* 数据链路层：加上源 MAC 地址和目标 MAC 地址，还有 FCS

  对于目标 MAC 地址，有两种情况

  * ARP 高速缓存里中映射，就可以直接知道
  * 如果没有，则源主机就会发送一条广播ARP请求分组，格式如图所示；对于目标主机接收到该请求后，会发送一条单播ARP响应分组给源主机。这样源主机就可以知道其MAC地址。

**情况二：主机** $$H_1$$ **和主机** $$H_2$$ **通信**

![](../.gitbook/assets/image%20%28153%29.png)

其他过程都一样，单独说明 $$H_1$$ 如何获取 $$H_2$$ 的 MAC 地址

* 主机 $$H_1$$ 知道主机 $$H_2$$ 不和自己同一网段，直接把数据报发给默认网关
* 路由器 $$R_1$$ 通过解封装和再封装，把数据报发送给下一跳路由器 $$R_2$$ 
* 路由器 $$R_2$$ 把报文发送给主机 $$H_2$$ ，封装方法和局域网的一样

**ARP协议：**完成主机或路由器 IP 地址到 MAC 地址的映射（解决下一跳走哪的问题）

**ARP协议使用过程：**

* 检查 **ARP 高速缓存**，有对应表项则写入 MAC 帧，没有则用目的 MAC 地址为  FF-FF-FF-FF-FF-FF 帧封装并广播 ARP 请求分组，同一局域网中所有主机都能收到该请求。目的主机收到请求后就会向源主机**单播一个 ARP 响应分组**，源主机收到后将此映射**写入ARP 缓存**（10 - 20 min 更新一次）

**ARP 协议 4 中典型情况：**

1. 主机 A 发给**本网络**上的主机 B：用 ARP 找到主机 B 的硬件地址
2. 主机 A 发给**另一网络**上的主机 B：用 ARP 找到本网络上一个路由器（网关）的硬件地址
3. 路由器发给**本网络**的主机 A：用 ARP 找到主机 A 的硬件地址
4. 路由器发给**另一网络**的主机 B：用 ARP 找到本网络上的一个路由器的硬件地址



