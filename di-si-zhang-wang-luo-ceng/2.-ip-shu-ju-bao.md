# 2. IP 数据报

## 1. IP 数据报格式

### 1.1 TCP/IP 协议栈

![](../.gitbook/assets/image%20%2896%29.png)

### 1.2 IP 数据报格式

![](../.gitbook/assets/image%20%28118%29.png)

#### 首部细节

![](../.gitbook/assets/image%20%28113%29.png)

**版本：**占 4 位，指 IP 协议的版本。（IPv4/IPv6）

**首部长度：**占 4 位，**单位是 4B**，最小为 5（因为首部固定部分 20B，5 \* 4B = 20B），最大为 15（15 \* 4B = 60B）

**区分服务：**占 8 位，用来获取更好的服务（如：优先级），但实际上一直没有用过

**总长度：**占 16 位，首部 + 数据部分的总长度，**单位是 1B**，因此数据报的总长度为 $$2^{16} - 1 = 65535 B$$ 

**生存时间（TTL）：**占 8 位，IP 分组的保质期，经过一个路由器就 -1，变为 0 则丢弃

**协议：**占 8 位，数据部分的协议，即传输层使用的是什么协议

| 协议名 | ICMP | IGMP | TCP | EGP | IGP | UDP | IPv6 | ESP | OSPF |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| 字段值 | 1 | 2 | **6** | 8 | 9 | **17** | 41 | 50 | 89 |

**首部检验和：**占 16 位，只检验数据报的首部，但不包含数据部分。每经过一个路由器，都会重新计算一下首部检验和。

**源地址：**占 32 位

**目的地址：**占 32 位

**可选字段：**占 0 ~ 40 位，用来支持排错、测量以及安全措施

**填充：**全 0，把首部长度补成 4B 的整数倍

### 1.3 IP 数据报分片

**最大传输单元MTU：**数据链路层帧可封装数据的上限，以太网的MTU是1500字节。

![](../.gitbook/assets/image%20%2894%29.png)

![](../.gitbook/assets/image%20%2892%29.png)

**标识：**占 16 位，同一数据报的分片使用同一标识

**标志：**占 3 位，只有两位有意义 x \_ \_

* 中间位 DF（Don't Fragment）
  * DF = 1，禁止分片
  * DF = 0，允许分片
* 最低位 MF（More Fragment）
  * MF = 1，后面还有分片
  * MF = 0，代表最后一片 / 没分片

**片偏移：**指出较长分组分片后，某片在原分组中的相对位置。**（以 8B 为单位）**

* 除了最后一片，每个分片长度一定是 **8B 的整数倍**

![](../.gitbook/assets/image%20%2868%29.png)

## 2. IPv4 地址

IP 地址是唯一标识一个计算机的地址

### 2.1 IP 编址的历史阶段

1. 分类的 IP 地址
2. 子网的划分
3. 构成超网（无分类编址方式）

### 2.2 分类的 IP 地址

IP 地址：全世界唯一的 **32 为 / 4 字节** 标识符，标识路由器主机的接口

IP 地址 ::= {&lt;网络号&gt;，&lt;主机号&gt;}

![](../.gitbook/assets/image%20%28147%29.png)

### 2.3 互联网中的 IP 地址

![](../.gitbook/assets/image%20%28150%29.png)

### 2.4 IP 地址的分类

![](../.gitbook/assets/image%20%28148%29.png)

### 2.5 特殊 IP 地址

![](../.gitbook/assets/image%20%28151%29.png)

### 2.6 私有 IP 地址

![](../.gitbook/assets/image%20%28149%29.png)

### 2.7 IP 地址的范围

![](../.gitbook/assets/image%20%28146%29.png)

对于 A 类地址，0.0.0.0 和 127.0.0.0 不能用作网络号

对于 B 类地址，128.0.0.0 不能作为网络号

对于 C 类地址，192.0.0.0 不能作为网络号

## 3. 网络地址转换（NAT）



