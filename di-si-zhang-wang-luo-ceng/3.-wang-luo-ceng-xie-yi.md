# 3. 网络层协议

## 1. ARP 协议

对于数据链路层，通过 MAC 地址找到对应的主机。A 和 B 通信有两种情况：

* 情况一：A 和 B 在同一局域网内
* 情况二：A 和 B 不在同一局域网内

**对于情况一：主机 1 和主机 3 通信**

![](../.gitbook/assets/image%20%28160%29.png)

* 应用层：递交给传输层
* 传输层：分组，递交给网络层
* 网络层：对于第一个分组，加上源 IP 地址和目标 IP 地址，递交给数据链路层
* 数据链路层：加上源 MAC 地址和目标 MAC 地址，还有 FCS

  对于目标 MAC 地址，有两种情况

  * ARP 高速缓存里中映射，就可以直接知道
  * 如果没有，则源主机就会发送一条广播ARP请求分组，格式如图所示；对于目标主机接收到该请求后，会发送一条单播ARP响应分组给源主机。这样源主机就可以知道其MAC地址。

**情况二：主机** $$H_1$$ **和主机** $$H_2$$ **通信**

![](../.gitbook/assets/image%20%28153%29.png)

其他过程都一样，单独说明 $$H_1$$ 如何获取 $$H_2$$ 的 MAC 地址

* 主机 $$H_1$$ 知道主机 $$H_2$$ 不和自己同一网段，直接把数据报发给默认网关
* 路由器 $$R_1$$ 通过解封装和再封装，把数据报发送给下一跳路由器 $$R_2$$ 
* 路由器 $$R_2$$ 把报文发送给主机 $$H_2$$ ，封装方法和局域网的一样

**ARP协议：**完成主机或路由器 IP 地址到 MAC 地址的映射（解决下一跳走哪的问题）

**ARP协议使用过程：**

* 检查 **ARP 高速缓存**，有对应表项则写入 MAC 帧，没有则用目的 MAC 地址为  FF-FF-FF-FF-FF-FF 帧封装并广播 ARP 请求分组，同一局域网中所有主机都能收到该请求。目的主机收到请求后就会向源主机**单播一个 ARP 响应分组**，源主机收到后将此映射**写入ARP 缓存**（10 - 20 min 更新一次）

**ARP 协议 4 中典型情况：**

1. 主机 A 发给**本网络**上的主机 B：用 ARP 找到主机 B 的硬件地址
2. 主机 A 发给**另一网络**上的主机 B：用 ARP 找到本网络上一个路由器（网关）的硬件地址
3. 路由器发给**本网络**的主机 A：用 ARP 找到主机 A 的硬件地址
4. 路由器发给**另一网络**的主机 B：用 ARP 找到本网络上的一个路由器的硬件地址

